#! /bin/bash

OK="\033[1;32m OK  \033[0m"
FAIL="\033[1;31m  FAILED  \033[0m"

branch=$1

echo -n "Rebuilding ALL"
if [ "$branch" != "" ];
then
    echo " in branch $branch"
else
    echo " in the current branches"
fi

host=`hostname`
if [ "$host" == "bonus" ] || [ "$host" == "kokos" ]
then
    prefix="/home/sloot/usr/local/"
else
    wd=`pwd`
    prefix="${wd}/../usr/local/"
fi

dirs='ticcutils timbl timblserver mbt mbtserver dimbl libfolia foliatest uctodata ucto frogdata frog foliautils ticcltools toad wopr tscan'
exes='timbl timblserver mbt mbtserver dimbl ucto frog FoLiA-stats FoLiA-alto FoLiA-hocr TICCL-lexclean TICCL-indexerNT wopr tscan'

#sanity check
for app in $dirs
do
    if ! test -d $app
    then
	echo "$app dir not found. Could become troublesome"
	exit
    fi
done

# configure and make all
for app in $dirs
do
    if test -d $app
    then
	name=$app
	name=${name/\//_}
	pushd $app > ../$name.log 2>&1
	echo -n "$app: updating"
	if [ "$branch" != "" ];
	then
	    git checkout --quiet $branch > /dev/null 2>&1
	    if [ $? -ne 0 ];
	    then
		# branch bestaat niet, blijf waar je bent
		echo -n " [ NO $branch, sticking to: `git rev-parse --abbrev-ref HEAD`]"
	    else
		echo -n " [$branch]"
	    fi
	else
	    echo -n " [`git rev-parse --abbrev-ref HEAD`]"
	fi
	git pull > ../$name.log 2>&1
	if [ $? -ne 0 ];
	then
	    echo -e $FAIL
	    popd
	    echo "see $name.log"
	    exit
	fi
	make maintainer-clean > ../$name.log 2>&1
	rm -f config.{guess,sub}
	sh ./bootstrap.sh >> ../$name.log 2>&1
	if [ $? -ne 0 ];
	then
	    echo -e $FAIL
	    popd
	    echo "see $name.log"
	    exit
	fi

	echo -n ", configuring"
	CXXFLAGS="-pedantic -W -Wall -O3 " ./configure --prefix=$prefix > ../$name.log 2>&1
	if [ $? -ne 0 ];
	then
	    echo -e $FAIL
	    popd
	    echo "see $name.log"
	    exit
	fi

	echo -n ", making"
	make install >> ../$name.log 2>&1
	if [ $? -ne 0 ];
	then
	    echo -e $FAIL
	    popd
	    echo "see $name.log"
	    exit
	fi

	echo -n ", checking"
	make check >> ../$name.log 2>&1
	if [ $? -ne 0 ];
	then
	    echo -e $FAIL
	    popd
	    echo "see $name.log"
	    exit
	else
	    echo -e $OK
	fi
	popd  >> ../$name.log 2>&1
    else
	echo "$app dir not found. Could become troublesome"
	exit 1
    fi
done

# poor mans test
for app in $exes
do
    if test -x $prefix/bin/$app
    then
	$prefix/bin/$app -V  > $name.log 2>&1
	if [ $? -ne 0 ];
	then
	    echo -e $FAIL
	    echo "see $name.log"
	else
	    echo -n "testing $app: "
	    echo -e $OK
	fi
    else
	echo "couldn't find $app executable"
    fi
done
